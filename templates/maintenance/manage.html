{% extends 'base.html' %}

{% block title %}จัดการรายการแจ้งซ่อม{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow p-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">จัดการรายการแจ้งซ่อม</h1>
        <div class="flex gap-2">
            <select id="statusFilter" class="rounded-md border-gray-300">
                <option value="">ทั้งหมด</option>
                <option value="PENDING">รอดำเนินการ</option>
                <option value="IN_PROGRESS">กำลังดำเนินการ</option>
                <option value="COMPLETED">เสร็จสิ้น</option>
                <option value="CANCELLED">ยกเลิก</option>
            </select>
            <select id="priorityFilter" class="rounded-md border-gray-300">
                <option value="">ทุกระดับความสำคัญ</option>
                <option value="URGENT">ฉุกเฉิน</option>
                <option value="HIGH">สูง</option>
                <option value="MEDIUM">ปานกลาง</option>
                <option value="LOW">ต่ำ</option>
            </select>
        </div>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">หัวข้อ</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ผู้แจ้ง</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">สถานะ</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ความสำคัญ</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">วันที่แจ้ง</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">การดำเนินการ</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="requestsTable">
                {% for request in maintenance_requests %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        #{{ request.id }}
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900">{{ request.title }}</div>
                        <div class="text-sm text-gray-500">{{ request.location }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {{ request.requestor.get_full_name }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <select class="status-select rounded-md text-sm" data-request-id="{{ request.id }}">
                            {% for status in status_choices %}
                            <option value="{{ status.0 }}" {% if status.0 == request.status %}selected{% endif %}>
                                {{ status.1 }}
                            </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                            {% if request.priority == 'URGENT' %}bg-red-100 text-red-800
                            {% elif request.priority == 'HIGH' %}bg-orange-100 text-orange-800
                            {% elif request.priority == 'MEDIUM' %}bg-yellow-100 text-yellow-800
                            {% else %}bg-green-100 text-green-800{% endif %}">
                            {{ request.get_priority_display }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ request.created_at|date:"d/m/Y H:i" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex gap-2">
                            <a href="{% url 'maintenance:maintenance_detail' request.id %}"
                               class="text-blue-600 hover:text-blue-900">ดูรายละเอียด</a>
                            {% if request.status == 'PENDING' %}
                            <button onclick="approveRequest({{ request.id }})"
                                    class="text-green-600 hover:text-green-900">อนุมัติ</button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal for Approval -->
<div id="approvalModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">อนุมัติการแจ้งซ่อม</h3>
            <div class="mt-2 px-7 py-3">
                <form id="approvalForm">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">มอบหมายช่าง</label>
                        <select id="technicianSelect" class="shadow border rounded w-full py-2 px-3 text-gray-700">
                            {% for tech in technicians %}
                            <option value="{{ tech.id }}">{{ tech.get_full_name|default:tech.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">หมายเหตุ</label>
                        <textarea id="approvalNote" class="shadow border rounded w-full py-2 px-3 text-gray-700" rows="3"></textarea>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="button" onclick="closeApprovalModal()"
                                class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                            ยกเลิก
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                            ยืนยัน
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentRequestId = null;

document.addEventListener('DOMContentLoaded', function() {
    // Status change handler
    document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', function() {
            const requestId = this.dataset.requestId;
            const newStatus = this.value;
            updateStatus(requestId, newStatus);
        });
    });

    // Filters
    ['statusFilter', 'priorityFilter'].forEach(filterId => {
        document.getElementById(filterId).addEventListener('change', applyFilters);
    });
});

function updateStatus(requestId, status) {
    fetch(`/api/maintenance/${requestId}/status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('อัพเดทสถานะสำเร็จ', 'success');
        } else {
            showNotification('เกิดข้อผิดพลาด', 'error');
        }
    });
}

function approveRequest(requestId) {
    currentRequestId = requestId;
    document.getElementById('approvalModal').classList.remove('hidden');
}

function closeApprovalModal() {
    document.getElementById('approvalModal').classList.add('hidden');
    currentRequestId = null;
}

document.getElementById('approvalForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const technicianId = document.getElementById('technicianSelect').value;
    const note = document.getElementById('approvalNote').value;

    fetch(`/api/maintenance/${currentRequestId}/approve/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            technician_id: technicianId,
            note: note
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('อนุมัติการแจ้งซ่อมสำเร็จ', 'success');
            location.reload();
        } else {
            showNotification('เกิดข้อผิดพลาด', 'error');
        }
    });

    closeApprovalModal();
});

function applyFilters() {
    const status = document.getElementById('statusFilter').value;
    const priority = document.getElementById('priorityFilter').value;

    document.querySelectorAll('#requestsTable tr').forEach(row => {
        let show = true;

        if (status && row.querySelector('.status-select').value !== status) {
            show = false;
        }

        if (priority && !row.querySelector(`[data-priority="${priority}"]`)) {
            show = false;
        }

        row.style.display = show ? '' : 'none';
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showNotification(message, type) {
    // Implementation of notification system
    console.log(`${type}: ${message}`);
}
</script>
{% endblock %}
